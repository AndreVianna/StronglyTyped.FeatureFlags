namespace StronglyTyped.FeatureFlags.SourceGeneration.Tests;
using static Helpers.GeneratorRunner;

[ExcludeFromCodeCoverage]
public class SourceGenerationTests {

    #region content strings
    private const string _emptyInterface = @"// <auto-generated/>
#nullable enable

using StronglyTyped.FeatureFlags;

namespace SourceGeneration.Tests;

public interface ITestFeatures
{
}
";

    private const string _emptyClass = @"// <auto-generated/>
#nullable enable

using StronglyTyped.FeatureFlags;

namespace SourceGeneration.Tests;

partial class TestFeatures : ITestFeatures
{
    private readonly IFeatureReader _featureReader;

    public TestFeatures(IFeatureReader featureReader)
    {
        _featureReader = featureReader;
    }
}
";

    private const string _interfaceWithTwoProperties = @"// <auto-generated/>
#nullable enable

using StronglyTyped.FeatureFlags;

namespace SourceGeneration.Tests;

public interface ITestFeatures
{
    IFeatureState Feature1 { get; }
    IFeatureState Feature2 { get; }
}
";

    private const string _classWithTwoProperties = @"// <auto-generated/>
#nullable enable

using StronglyTyped.FeatureFlags;

namespace SourceGeneration.Tests;

partial class TestFeatures : ITestFeatures
{
    private readonly IFeatureReader _featureReader;

    public TestFeatures(IFeatureReader featureReader)
    {
        _featureReader = featureReader;
    }

    public IFeatureState Feature1 => _featureReader.For(""Feature1"");
    public IFeatureState Feature2 => _featureReader.For(""Feature2"");
}
";


    private const string _interfaceWithSubSection = @"// <auto-generated/>
#nullable enable

using StronglyTyped.FeatureFlags;

namespace SourceGeneration.Tests;

public interface ITestFeatures
{
    IFeatureState Feature1 { get; }
    IFeatureState Feature2 { get; }

    ITestSubFeatures TestSubFeatures { get; }
}
";

    private const string _classWithSubSection = @"// <auto-generated/>
#nullable enable

using StronglyTyped.FeatureFlags;

namespace SourceGeneration.Tests;

partial class TestFeatures : ITestFeatures
{
    private readonly IFeatureReader _featureReader;

    public TestFeatures(IFeatureReader featureReader)
    {
        _featureReader = featureReader;
        TestSubFeatures = new TestSubFeatures(_featureReader);
    }

    public IFeatureState Feature1 => _featureReader.For(""Feature1"");
    public IFeatureState Feature2 => _featureReader.For(""Feature2"");

    public ITestSubFeatures TestSubFeatures { get; }
}
";

    private const string _subSectionInterface = @"// <auto-generated/>
#nullable enable

using StronglyTyped.FeatureFlags;

namespace SourceGeneration.Tests;

public interface ITestSubFeatures
{
    IFeatureState Feature3 { get; }
    IFeatureState Feature4 { get; }
}
";

    private const string _subSectionClass = @"// <auto-generated/>
#nullable enable

using StronglyTyped.FeatureFlags;

namespace SourceGeneration.Tests;

partial class TestSubFeatures : ITestSubFeatures
{
    private readonly IFeatureReader _featureReader;

    public TestSubFeatures(IFeatureReader featureReader)
    {
        _featureReader = featureReader;
    }

    public IFeatureState Feature3 => _featureReader.For(""Feature3"");
    public IFeatureState Feature4 => _featureReader.For(""Feature4"");
}
";
    #endregion

    [Theory]
    [InlineData("string")]
    [InlineData("String")]
    [InlineData("System.String")]
    public async Task SourceFile_WithAClass_WithFeatureReaderDefinitionAttribute_AndAPrivateStringArrayField_InitializedWithTwoFeatures_GeneratesCode_WithTwoProperties(string arrayType) {
        var code = @$"
using StronglyTyped.FeatureFlags;

namespace SourceGeneration.Tests;

[FeaturesSectionDefinition]
public partial class TestFeatures {{
    [Features]
    private static readonly {arrayType}[] _features = {{
        ""Feature1"",
        ""Feature2""
    }};
}}
";

        var (diagnostics, resultedCode) = await RunAsync(code);

        diagnostics.Length.Should().Be(0);
        resultedCode.Length.Should().Be(2);
        resultedCode[0].SourceText.ToString().Should().Be(_interfaceWithTwoProperties);
        resultedCode[1].SourceText.ToString().Should().Be(_classWithTwoProperties);
    }

    [Fact]
    public async Task SourceFile_WithOldNamespacesStyle_AndValidClass_GeneratesCode_WithTwoProperties() {
        const string code = @"
using StronglyTyped.FeatureFlags;

namespace SourceGeneration.Tests {
    [FeaturesSectionDefinition]
    public partial class TestFeatures {
        [Features]
        private static readonly string[] _features = {
            ""Feature1"",
            ""Feature2""
        };
    }
}
";

        var (diagnostics, resultedCode) = await RunAsync(code);

        diagnostics.Length.Should().Be(0);
        resultedCode.Length.Should().Be(2);
        resultedCode[0].SourceText.ToString().Should().Be(_interfaceWithTwoProperties);
        resultedCode[1].SourceText.ToString().Should().Be(_classWithTwoProperties);
    }

    [Fact]
    public async Task SourceFile_WithAValidClass_WithSubSection_GeneratesCode_WithSubSection() {
        const string code = @"
using StronglyTyped.FeatureFlags;

namespace SourceGeneration.Tests;

[FeaturesSectionDefinition]
public partial class TestFeatures {
    [Features]
    private static readonly string[] _features = {
        ""Feature1"",
        ""Feature2""
    };

    [Sections]
    private static readonly string[] _sections = {
        nameof(TestSubFeatures)
    };
}
";

        var (diagnostics, resultedCode) = await RunAsync(code);

        diagnostics.Length.Should().Be(0);
        resultedCode.Length.Should().Be(2);
        resultedCode[0].SourceText.ToString().Should().Be(_interfaceWithSubSection);
        resultedCode[1].SourceText.ToString().Should().Be(_classWithSubSection);
    }

    [Fact]
    public async Task SourceFile_WithAValidClass_WithMultipleClasses_GeneratesCode_WithSubSection() {
        const string code = @"
using StronglyTyped.FeatureFlags;

namespace SourceGeneration.Tests;

[FeaturesSectionDefinition]
public partial class TestFeatures {
    [Features]
    private static readonly string[] _features = {
        ""Feature1"",
        ""Feature2""
    };

    [Sections]
    private static readonly string[] _sections = {
        nameof(TestSubFeatures)
    };
}

[FeaturesSectionDefinition]
public partial class TestSubFeatures {
    [Features]
    private static readonly string[] _features = {
        ""Feature3"",
        ""Feature4""
    };
}
";

        var (diagnostics, resultedCode) = await RunAsync(code);

        diagnostics.Length.Should().Be(0);
        resultedCode.Length.Should().Be(4);
        resultedCode[0].SourceText.ToString().Should().Be(_interfaceWithSubSection);
        resultedCode[1].SourceText.ToString().Should().Be(_classWithSubSection);
        resultedCode[2].SourceText.ToString().Should().Be(_subSectionInterface);
        resultedCode[3].SourceText.ToString().Should().Be(_subSectionClass);
    }


    [Fact]
    public async Task SourceFile_WithAValidClass_WithMultipleClasses_AndError_GeneratesCode_WithSubSection() {
        const string code = @"
using StronglyTyped.FeatureFlags;

namespace SourceGeneration.Tests;

[FeaturesSectionDefinition]
public partial class TestFeatures {
    [Features]
    private static readonly string[] _features = {
        ""Feature1"",
        ""Feature2""
    };

    [Sections]
    private static readonly string[] _sections = {
        nameof(TestSubFeatures)
    };
}

[FeaturesSectionDefinition]
public partial class TestSubFeatures {
    [Features]
    private static string _features;
}
";

        var (diagnostics, resultedCode) = await RunAsync(code);

        diagnostics.Length.Should().Be(1);
        resultedCode.Length.Should().Be(2);
        resultedCode[0].SourceText.ToString().Should().Be(_interfaceWithSubSection);
        resultedCode[1].SourceText.ToString().Should().Be(_classWithSubSection);
    }

    [Fact]
    public async Task SourceFile_WithoutNamespace_DoesNotGenerateCode() {
        const string code = @"
using StronglyTyped.FeatureFlags;

[FeaturesSectionDefinition]
public partial class TestFeatures {
    [Features]
    private static readonly string[] _features = {
        ""Feature1"",
        ""Feature2""
    };
}
";

        var (diagnostics, resultedCode) = await RunAsync(code);

        diagnostics.Length.Should().Be(0);
        resultedCode.Length.Should().Be(0);
    }

    [Fact]
    public async Task SourceFile_WithAClassWithNoAttributes_DoesNotGenerateCode() {
        const string code = @"
using StronglyTyped.FeatureFlags;

namespace SourceGeneration.Tests;

public partial class TestFeatures {
    [Features]
    private static readonly string[] _features = {
        ""Feature1"",
        ""Feature2""
    };
}
";

        var (diagnostics, resultedCode) = await RunAsync(code);

        diagnostics.Length.Should().Be(0);
        resultedCode.Length.Should().Be(0);
    }

    [Fact]
    public async Task SourceFile_WithAClass_WithoutFeatureReaderDefinitionAttribute_DoesNotGenerateCode() {
        const string code = @"
using StronglyTyped.FeatureFlags;

namespace SourceGeneration.Tests;

[Obsolete]
public partial class TestFeatures {
    [Features]
    private static readonly string[] _features = {
        ""Feature1"",
        ""Feature2""
    };
}
";

        var (diagnostics, resultedCode) = await RunAsync(code);

        diagnostics.Length.Should().Be(0);
        resultedCode.Length.Should().Be(0);
    }

    [Fact]
    public async Task SourceFile_WithAValidClass_WithNotPrivateField_GeneratesCode_WithNoProperties() {
        const string code = @"
using StronglyTyped.FeatureFlags;

namespace SourceGeneration.Tests;

[FeaturesSectionDefinition]
public partial class TestFeatures {
    [Features]
    public static readonly string[] _features = {
        ""Feature1"",
        ""Feature2""
    };
}
";

        var (diagnostics, resultedCode) = await RunAsync(code);

        diagnostics.Length.Should().Be(1);
        diagnostics[0].ToString().Should().Contain("warning FG002: The selected field must be private.");
        resultedCode.Length.Should().Be(0);
    }

    [Fact]
    public async Task SourceFile_WithAValidClass_WithNotArrayField_GeneratesCode_WithNoProperties() {
        const string code = @"
using StronglyTyped.FeatureFlags;

namespace SourceGeneration.Tests;

[FeaturesSectionDefinition]
public partial class TestFeatures {
    [Sections]
    private static string _features;
}
";

        var (diagnostics, resultedCode) = await RunAsync(code);

        diagnostics.Length.Should().Be(1);
        diagnostics[0].ToString().Should().Contain("warning FG001: The selected field must be a string array.");
        resultedCode.Length.Should().Be(0);
    }

    [Fact]
    public async Task SourceFile_WithAValidClass_WithNoInitializer_GeneratesCode_WithNoProperties() {
        const string code = @"
using StronglyTyped.FeatureFlags;

namespace SourceGeneration.Tests;

[FeaturesSectionDefinition]
public partial class TestFeatures {{
    [Features]
    private static readonly string[] _features;
}}
";

        var (diagnostics, resultedCode) = await RunAsync(code);

        diagnostics.Length.Should().Be(0);
        resultedCode.Length.Should().Be(2);
        resultedCode[0].SourceText.ToString().Should().Be(_emptyInterface);
        resultedCode[1].SourceText.ToString().Should().Be(_emptyClass);
    }

    [Fact]
    public async Task SourceFile_WithAValidClass_WithAnArrayOfAnInvalidType_GeneratesCode_WithNoProperties() {
        const string code = @"
using StronglyTyped.FeatureFlags;

namespace SourceGeneration.Tests;

[FeaturesSectionDefinition]
public partial class TestFeatures {
    [Features]
    private static readonly int[] _features = {
        1,
        2
    };
}
";

        var (diagnostics, resultedCode) = await RunAsync(code);

        diagnostics.Length.Should().Be(1);
        diagnostics[0].ToString().Should().Contain("warning FG001: The selected field must be a string array.");
        resultedCode.Length.Should().Be(0);
    }

    [Fact]
    public async Task SourceFile_WithAValidClass_WithAnEmptyStringArray_GeneratesCode_WithNoProperties() {
        const string code = @"
using StronglyTyped.FeatureFlags;

namespace SourceGeneration.Tests;

[FeaturesSectionDefinition]
public partial class TestFeatures {
    [Features]
    private static readonly String[] _features = {
    };
}
";

        var (diagnostics, resultedCode) = await RunAsync(code);

        diagnostics.Length.Should().Be(0);
        resultedCode.Length.Should().Be(2);
        resultedCode[0].SourceText.ToString().Should().Be(_emptyInterface);
        resultedCode[1].SourceText.ToString().Should().Be(_emptyClass);
    }

    [Fact]
    public async Task SourceFile_WithAValidClass_WithNonLiteralValue_GeneratesCode_WithOnlyLiteralValues() {
        const string code = @"
using StronglyTyped.FeatureFlags;

namespace SourceGeneration.Tests;

[FeaturesSectionDefinition]
public partial class TestFeatures {
    private const string _feature3 = ""Feature3"";

    [Features]
    private static readonly string[] _features = {
        ""Feature1"",
        ""Feature2""
        nameof(TestSubFeatures),
        _feature3,
        $""Feature{4}""
    };

    [Sections]
    private static readonly string[] _sections = {
        nameof(TestSubFeatures)
        ""OtherTestSubFeatures""
        _feature3,
        $""Feature{4}"" 
    };
}
";

        var (diagnostics, resultedCode) = await RunAsync(code);

        diagnostics.Length.Should().Be(6);
        diagnostics[0].ToString().Should().Contain("warning FG003: The feature name must be a string literal. Instead found 'nameof(TestSubFeatures)'.");
        diagnostics[1].ToString().Should().Contain("warning FG003: The feature name must be a string literal. Instead found '_feature3'.");
        diagnostics[2].ToString().Should().Contain("warning FG003: The feature name must be a string literal. Instead found '$\"Feature{4}\"'.");
        diagnostics[3].ToString().Should().Contain("warning FG004: The section name must use 'nameof' keyword. Instead found '\"OtherTestSubFeatures\"'.");
        diagnostics[4].ToString().Should().Contain("warning FG004: The section name must use 'nameof' keyword. Instead found '_feature3'.");
        diagnostics[5].ToString().Should().Contain("warning FG004: The section name must use 'nameof' keyword. Instead found '$\"Feature{4}\"'.");
        resultedCode.Length.Should().Be(2);
        resultedCode[0].SourceText.ToString().Should().Be(_interfaceWithSubSection);
        resultedCode[1].SourceText.ToString().Should().Be(_classWithSubSection);
    }
}
