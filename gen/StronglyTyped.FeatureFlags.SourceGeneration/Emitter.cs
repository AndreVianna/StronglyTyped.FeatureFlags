namespace StronglyTyped.FeatureFlags.SourceGeneration;

internal class Emitter {
    private const int _defaultStringBuilderCapacity = 1024;
    private readonly StringBuilder _builder = new(_defaultStringBuilderCapacity);

    internal void EmitFiles(SourceProductionContext context, IReadOnlyList<FeatureAccessorDefinition> flagsSelectors) {
        foreach (var flagsSelector in flagsSelectors) {
            context.CancellationToken.ThrowIfCancellationRequested();
            var interfaceCode = EmitInterface(flagsSelector);
            context.AddSource($"I{flagsSelector.Name}.g.cs", SourceText.From(interfaceCode, Encoding.UTF8));

            var classCode = EmitClass(flagsSelector);
            context.AddSource($"{flagsSelector.Name}.g.cs", SourceText.From(classCode, Encoding.UTF8));
        }
    }

    private string EmitInterface(FeatureAccessorDefinition definition) {
        _builder.Clear();
        _builder.AppendLine("// <auto-generated/>");
        _builder.AppendLine("#nullable enable");
        GenInterface(definition);
        return _builder.ToString();
    }

    private string EmitClass(FeatureAccessorDefinition definition) {
        _builder.Clear();
        _builder.AppendLine("// <auto-generated/>");
        _builder.AppendLine("#nullable enable");
        GenClass(definition);
        return _builder.ToString();
    }

    private void GenInterface(FeatureAccessorDefinition definition) {
        _builder.Append("" +
@$"
using StronglyTyped.FeatureFlags;

namespace {definition.Namespace};

public interface I{definition.Name}
{{
");
        foreach (var feature in definition.Features) {
            _builder.Append("" +
@$"    IFeatureState {feature} {{ get; }}
");
        }

        foreach (var section in definition.Sections) {
            _builder.Append(
@$"    I{section} {section} {{ get; }}
");
        }

        _builder.Append("" +
                        @"}
");
    }


    private void GenClass(FeatureAccessorDefinition definition) {
        _builder.Append("" +
@$"
using StronglyTyped.FeatureFlags;

namespace {definition.Namespace};

partial class {definition.Name} : I{definition.Name}
{{
    private readonly IFeatureAccessor _featureAccessor;

    public {definition.Name}(IFeatureAccessor featureAccessor)
    {{
        _featureAccessor = featureAccessor;
");

        foreach (var section in definition.Sections) {
            _builder.Append(
@$"        {section} = new {section}(_featureAccessor);
");
        }

        _builder.Append(
@"    }
");

        foreach (var feature in definition.Features) {
            _builder.Append(
@$"    public IFeatureState {feature} => _featureAccessor.For(nameof({feature}));
");
        }

        foreach (var section in definition.Sections) {
            _builder.Append(
@$"    public I{section} {section} {{ get; }}
");
        }

        _builder.Append(
@"}
");
    }
}
